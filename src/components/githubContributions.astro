---
const login = import.meta.env.GITHUB_LOGIN ?? "pardeep1916P";
const token = import.meta.env.GITHUB_TOKEN;

// Types
type CalendarWeek = {
  firstDay: string;
  contributionDays: Array<{
    date: string;
    contributionCount: number;
    color: string;
  }>;
};

type Calendar = {
  totalContributions: number;
  colors: string[];
  weeks: CalendarWeek[];
};

// Data containers
let calendarsByYear: Record<number, Calendar | null> = {};
let repos: Array<{
  name: string;
  url: string;
  description: string | null;
  stargazerCount: number;
  forkCount: number;
  isArchived: boolean;
  isPrivate: boolean;
}> = [];
let error: string | null = null;

const currentYear = new Date().getFullYear();
// Include current year and two previous years (2026, 2025, 2024)
const years = [currentYear, currentYear - 1, currentYear - 2];

function isoRangeForYear(y: number) {
  const from = new Date(Date.UTC(y, 0, 1)).toISOString();
  const to = new Date(Date.UTC(y, 11, 31, 23, 59, 59)).toISOString();
  return { from, to };
}

if (!token) {
  error = "Missing GITHUB_TOKEN environment variable.";
} else {
  try {
    // Fetch calendars for each year in parallel
    const calendarPromises = years.map(async (y) => {
      const { from, to } = isoRangeForYear(y);
      const res = await fetch("https://api.github.com/graphql", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          query: `
            query($login: String!, $from: DateTime!, $to: DateTime!) {
              user(login: $login) {
                contributionsCollection(from: $from, to: $to) {
                  contributionCalendar {
                    totalContributions
                    colors
                    weeks {
                      firstDay
                      contributionDays { date contributionCount color }
                    }
                  }
                }
              }
            }`,
          variables: { login, from, to },
        }),
      });
      if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
      const data = await res.json();
      const cal = data?.data?.user?.contributionsCollection?.contributionCalendar ?? null;
      calendarsByYear[y] = cal;
    });

    // Fetch repositories with accessible visibility (public/private)
    const reposRes = await fetch("https://api.github.com/graphql", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify({
        query: `
          query($login: String!, $reposFirst: Int!) {
            user(login: $login) {
              repositories(first: $reposFirst, orderBy: {field: UPDATED_AT, direction: DESC}) {
                nodes { name url description stargazerCount forkCount isArchived isPrivate }
              }
            }
          }`,
        variables: { login, reposFirst: 50 },
      }),
    });

    if (!reposRes.ok) throw new Error(`GitHub API error: ${reposRes.status}`);
    const reposData = await reposRes.json();
    const allRepos = reposData?.data?.user?.repositories?.nodes ?? [];

    // Filter to just the selected repos (case-insensitive matching)
    const allowedRepos = ["core-java-learning", "Terraform-Learnings-", "docker", "DSA_JAVA"];
    repos = allRepos.filter((r) => {
      const repoName = r.name || '';
      return allowedRepos.some(allowed => 
        repoName.toLowerCase() === allowed.toLowerCase() || 
        repoName === allowed
      );
    });

    await Promise.all(calendarPromises);

    // Ensure at least the current year's calendar exists
    if (!calendarsByYear[currentYear]) {
      throw new Error("Could not load contribution calendars.");
    }
  } catch (e: any) {
    error = e?.message ?? String(e);
  }
}

// Custom palette matching portfolio theme (dark + purple accent)
const portfolioPalette = [
  "#1a1a1a", // 0 level
  "#2a1f3f", // 1
  "#4a3573", // 2
  "#7b5bbf", // 3
  "#a476ff", // 4 (var(--sec))
];

function colorForCount(count: number): string {
  if (count <= 0) return portfolioPalette[0];
  if (count <= 2) return portfolioPalette[1];
  if (count <= 5) return portfolioPalette[2];
  if (count <= 9) return portfolioPalette[3];
  return portfolioPalette[4];
}

function filterWeeksUpToToday(weeks: CalendarWeek[]): CalendarWeek[] {
  const today = new Date();
  today.setHours(23, 59, 59, 999);
  
  return weeks
    .map((week) => ({
      ...week,
      contributionDays: week.contributionDays.filter((day) => {
        const dayDate = new Date(day.date);
        return dayDate <= today;
      })
    }))
    .filter((week) => week.contributionDays.length > 0);
}
---

<section id="contributions" class="py-12 pb-24 md:pb-12 border-t border-[#ffffff10] text-[var(--white)]">
  <div class="max-w-5xl mx-auto">
    <h2 class="text-lg text-[var(--sec)] mb-2 shiny-sec">My activity</h2>
    <h3 class="text-4xl md:text-5xl font-medium mb-8">GitHub Contributions</h3>

    {error ? (
      <div class="text-[var(--white-icon)] bg-[#1414149c] border border-[var(--white-icon-tr)] rounded-xl p-4">
        {error} Set `GITHUB_TOKEN` and optionally `GITHUB_LOGIN` in env.
      </div>
    ) : (
      <div class="space-y-6">
        {/* Year-separated calendar */}
        <div class="flex flex-col md:flex-row gap-4 items-start">
          <div class="flex-1 w-full overflow-hidden">
            {years.map((y) => {
              const cal = calendarsByYear[y];
              return (
                <div data-year-graph={y} class={y === currentYear ? "block" : "hidden"}>
                  {cal ? (
                    <div class="space-y-2">
                      <div class="contributions-graph-container overflow-x-auto -ml-9 -mr-9 pl-9 pr-9 sm:ml-0 sm:mr-0 sm:pl-4 sm:pr-4 sm:rounded-lg sm:bg-[#0d0d0d]/50 sm:border sm:border-[#ffffff08]" data-graph-container>
                        <div class="grid grid-flow-col grid-rows-7 gap-[2px] sm:gap-[3px] py-2" style="width: max-content;" data-contributions-grid>
                          {
                            filterWeeksUpToToday(cal.weeks).map((week) =>
                              week.contributionDays.map((day) => (
                                <div
                                  class="contribution-day w-[10px] h-[10px] sm:w-3 sm:h-3 md:w-[14px] md:h-[14px] rounded-[2px] sm:rounded-[3px] transition-all duration-200 hover:scale-125 hover:ring-2 hover:ring-[var(--sec)]/50 cursor-pointer"
                                  style={`background-color: ${colorForCount(day.contributionCount)};`}
                                  data-tooltip={`${day.date} \u2022 ${day.contributionCount} contributions`}
                                  data-count={day.contributionCount}
                                ></div>
                              ))
                            )
                          }
                        </div>
                      </div>
                      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4 text-xs sm:text-sm mt-4">
                        <div class="flex items-center gap-2">
                          <span class="text-[var(--sec)] font-semibold text-base sm:text-lg">{cal.totalContributions.toLocaleString()}</span>
                          <span class="text-[var(--white-icon)]">contributions in {y}</span>
                        </div>
                        <div class="flex items-center gap-2 text-[var(--white-icon)]">
                          <span class="text-xs opacity-70">Less</span>
                          <div class="flex gap-1">
                            {portfolioPalette.map((c) => (
                              <span class="w-3 h-3 rounded-[3px] transition-transform hover:scale-110" style={`background-color: ${c};`}></span>
                            ))}
                          </div>
                          <span class="text-xs opacity-70">More</span>
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div class="text-[var(--white-icon)]">No data for {y}.</div>
                  )}
                </div>
              );
            })}
          </div>

          {/* Year selector */}
          <div class="flex flex-row md:flex-col gap-2 w-full md:w-auto">
            {years.map((y) => (
              <button
                data-year-btn={y}
                class={`px-4 py-2.5 rounded-lg text-xs sm:text-sm border whitespace-nowrap transition-all duration-300 ${y === currentYear ? "bg-[var(--sec)] text-black font-semibold border-[var(--sec)] shadow-lg shadow-[var(--sec)]/20" : "bg-[#1414149c] text-[var(--white-icon)] border-[var(--white-icon-tr)] hover:text-white hover:border-[var(--sec)]/50 hover:bg-[#1a1a1a]"}`}
              >
                {y}
              </button>
            ))}
          </div>
        </div>

        {/* Selected repositories */}
        <div class="mt-6">
          <h4 class="text-2xl font-semibold mb-3">Repositories</h4>
          {repos.length === 0 ? (
            <p class="text-[var(--white-icon)]">No selected repositories available.</p>
          ) : (
            <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {repos.map((r) => (
                <li class="group rounded-xl border border-[var(--white-icon-tr)] bg-[#1414149c] p-5 transition-all duration-300 hover:border-[var(--sec)]/40 hover:bg-[#1a1a1a] hover:shadow-lg hover:shadow-[var(--sec)]/5 hover:-translate-y-1">
                  <div class="flex justify-between items-start">
                    <a href={r.url} target="_blank" rel="noopener noreferrer" class="text-xl font-medium text-white/90 hover:text-[var(--sec)] transition-colors duration-200 flex items-center gap-2">
                      <svg class="w-5 h-5 opacity-60 group-hover:opacity-100 transition-opacity" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                      {r.name}
                    </a>
                    <div class="flex gap-3 text-sm text-[var(--white-icon)]">
                      <span title="Stars" class="flex items-center gap-1 hover:text-yellow-400 transition-colors">‚≠ê {r.stargazerCount}</span>
                      <span title="Forks" class="flex items-center gap-1 hover:text-[var(--sec)] transition-colors">üç¥ {r.forkCount}</span>
                    </div>
                  </div>
                  {r.description ? (
                    <p class="mt-3 text-[var(--white-icon)] text-sm leading-relaxed">{r.description}</p>
                  ) : null}
                  <div class="mt-3 flex gap-2">
                    {r.isArchived ? (
                      <span class="inline-block text-xs px-2 py-1 rounded-full bg-yellow-500/10 text-yellow-400 border border-yellow-500/20">Archived</span>
                    ) : null}
                    {r.isPrivate ? (
                      <span class="inline-block text-xs px-2 py-1 rounded-full bg-[var(--sec)]/10 text-[var(--sec)] border border-[var(--sec)]/20">Private</span>
                    ) : null}
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>
    )}
  </div>
</section>

<script>
  // Year selector interactivity
  const buttons = Array.from(document.querySelectorAll('[data-year-btn]')) as HTMLButtonElement[];
  const graphs = Array.from(document.querySelectorAll('[data-year-graph]')) as HTMLElement[];

  function activate(year: string) {
    graphs.forEach((g) => {
      g.classList.toggle('hidden', g.getAttribute('data-year-graph') !== year);
      g.classList.toggle('block', g.getAttribute('data-year-graph') === year);
    });
    buttons.forEach((b) => {
      const isActive = b.getAttribute('data-year-btn') === year;
      b.classList.toggle('bg-[var(--sec)]', isActive);
      b.classList.toggle('text-black', isActive);
      b.classList.toggle('bg-[#1414149c]', !isActive);
      b.classList.toggle('text-[var(--white-icon)]', !isActive);
    });
  }

  buttons.forEach((b) => b.addEventListener('click', () => activate(b.getAttribute('data-year-btn')!)));

  // Auto-hide scrollbar on mobile
  const graphContainers = document.querySelectorAll('[data-graph-container]');
  graphContainers.forEach((container) => {
    let scrollTimeout: number;
    
    container.addEventListener('scroll', () => {
      container.classList.add('scrolling');
      
      clearTimeout(scrollTimeout);
      scrollTimeout = window.setTimeout(() => {
        container.classList.remove('scrolling');
      }, 1000);
    });
  });


  // Auto-scroll graph to show today's column on load
  function scrollToToday() {
    const graphContainers = document.querySelectorAll('[data-graph-container]');
    graphContainers.forEach((container) => {
      if (container instanceof HTMLElement && container.offsetParent !== null) {
        const grid = container.querySelector('.grid');
        if (!grid) return;
        
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0]; // YYYY-MM-DD format
        
        // Find the day element that matches today by checking title attribute
        const allDays = grid.querySelectorAll('div[title]');
        let todayElement: HTMLElement | null = null;
        
        allDays.forEach((day) => {
          const title = day.getAttribute('title') || '';
          if (title.includes(todayStr)) {
            todayElement = day as HTMLElement;
          }
        });
        
        if (todayElement) {
          // Get positions
          const containerWidth = container.clientWidth;
          const todayOffsetLeft = todayElement.offsetLeft;
          
          // Calculate the width of a single day including gap
          const todayRect = todayElement.getBoundingClientRect();
          const dayWidth = todayRect.width + 4; // Day width + gap (gap-1 = 4px)
          
          // Find all days and check for future dates
          const allDays = Array.from(grid.querySelectorAll('div[title]')) as HTMLElement[];
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          // Find which column today is in
          const todayIndex = allDays.indexOf(todayElement);
          const todayColumn = Math.floor(todayIndex / 7);
          
          // Check if today's column contains any future dates
          // If it does, we should only show up to today (not the whole column)
          let lastValidColumn = todayColumn;
          let hasFutureInTodayColumn = false;
          
          // Check all days in today's column for future dates
          for (let row = 0; row < 7; row++) {
            const dayIndex = todayColumn * 7 + row;
            if (dayIndex < allDays.length) {
              const day = allDays[dayIndex];
              const title = day.getAttribute('title') || '';
              const dateMatch = title.match(/(\d{4}-\d{2}-\d{2})/);
              if (dateMatch) {
                const dayDate = new Date(dateMatch[1]);
                dayDate.setHours(0, 0, 0, 0);
                if (dayDate > today) {
                  hasFutureInTodayColumn = true;
                  break;
                }
              }
            }
          }
          
          // If today's column has future dates, find the last column that doesn't
          if (hasFutureInTodayColumn) {
            // Go backwards from today's column to find the last column with no future dates
            for (let col = todayColumn; col >= 0; col--) {
              let columnHasFuture = false;
              for (let row = 0; row < 7; row++) {
                const dayIndex = col * 7 + row;
                if (dayIndex < allDays.length) {
                  const day = allDays[dayIndex];
                  const title = day.getAttribute('title') || '';
                  const dateMatch = title.match(/(\d{4}-\d{2}-\d{2})/);
                  if (dateMatch) {
                    const dayDate = new Date(dateMatch[1]);
                    dayDate.setHours(0, 0, 0, 0);
                    if (dayDate > today) {
                      columnHasFuture = true;
                      break;
                    }
                  }
                }
              }
              if (!columnHasFuture) {
                lastValidColumn = col;
                break;
              }
            }
          }
          
          // Find the last day in the last valid column
          const lastDayInColumn = allDays[lastValidColumn * 7 + 6];
          
          if (lastDayInColumn) {
            // Scroll so that the last valid column is the rightmost visible
            // Position the right edge of the last valid column at the right edge of container
            const columnRightEdge = lastDayInColumn.offsetLeft + dayWidth;
            const scrollPosition = columnRightEdge - containerWidth;
            
            // Clamp to valid scroll range - never scroll past the last valid column
            const minScroll = 0;
            const maxScroll = Math.max(0, container.scrollWidth - containerWidth);
            const finalScroll = Math.max(minScroll, Math.min(scrollPosition, maxScroll));
            
            container.scrollLeft = finalScroll;
          } else {
            // Fallback: use today's position directly, but ensure we don't show future
            const scrollPosition = todayOffsetLeft + dayWidth - containerWidth;
            const finalScroll = Math.max(0, Math.min(scrollPosition, container.scrollWidth - containerWidth));
            container.scrollLeft = finalScroll;
          }
        } else {
          // Fallback: scroll to show the last columns (but not all the way to empty space)
          const dayWidth = 14; // Approximate width per day
          const columnsToShow = 15; // Show last ~15 columns
          container.scrollLeft = Math.max(0, container.scrollWidth - (columnsToShow * dayWidth));
        }
      }
    });
  }

  // Scroll on initial load and when year changes
  function initScroll() {
    // Try multiple times to ensure graph is rendered
    scrollToToday();
    setTimeout(scrollToToday, 100);
    setTimeout(scrollToToday, 300);
    setTimeout(scrollToToday, 500);
  }

  document.addEventListener('DOMContentLoaded', () => {
    initScroll();
    
    // Also scroll when year changes
    buttons.forEach((b) => {
      b.addEventListener('click', () => {
        setTimeout(() => {
          scrollToToday();
          setTimeout(scrollToToday, 100);
        }, 150);
      });
    });
  });

  // Also try when window loads (in case DOMContentLoaded fired too early)
  window.addEventListener('load', () => {
    setTimeout(scrollToToday, 200);
  });

  // JavaScript tooltip for contribution days
  const tooltip = document.createElement('div');
  tooltip.id = 'contribution-tooltip';
  tooltip.style.cssText = `
    position: fixed;
    padding: 8px 12px;
    background: #0a0a0a;
    border: 1px solid #a476ff;
    border-radius: 8px;
    font-size: 12px;
    white-space: nowrap;
    pointer-events: none;
    z-index: 9999;
    color: white;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    font-weight: 500;
    opacity: 0;
    transition: opacity 0.15s ease;
  `;
  document.body.appendChild(tooltip);

  document.querySelectorAll('.contribution-day').forEach((day) => {
    day.addEventListener('mouseenter', (e) => {
      const target = e.target as HTMLElement;
      const text = target.getAttribute('data-tooltip');
      if (text) {
        tooltip.textContent = text;
        tooltip.style.opacity = '1';
      }
    });

    day.addEventListener('mousemove', (e) => {
      const mouseEvent = e as MouseEvent;
      tooltip.style.left = mouseEvent.clientX + 10 + 'px';
      tooltip.style.top = mouseEvent.clientY - 35 + 'px';
    });

    day.addEventListener('mouseleave', () => {
      tooltip.style.opacity = '0';
    });
  });
</script>

<style>
  .shiny-sec {
    background: linear-gradient(135deg, #a476ff 25%, #eee5ff 50%, #a476ff 75%);
    background-size: 400% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: shine 3s linear infinite;
  }

  @keyframes shine {
    0% {
      background-position: 100% 50%;
    }
    30%,
    70% {
      background-position: 0% 50%;
    }
  }

  /* Custom scrollbar for contributions graph only */
  .contributions-graph-container {
    scrollbar-width: thin;
    scrollbar-color: var(--sec) transparent;
    padding-bottom: 8px;
  }

  .contributions-graph-container::-webkit-scrollbar {
    height: 6px;
  }

  .contributions-graph-container::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 10px;
  }

  .contributions-graph-container::-webkit-scrollbar-thumb {
    background: linear-gradient(90deg, var(--sec), #7b5bbf);
    border-radius: 10px;
    transition: background 0.3s ease;
  }

  .contributions-graph-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(90deg, #b595ff, var(--sec));
  }

  /* Auto-hide scrollbar on mobile */
  @media (max-width: 767px) {
    .contributions-graph-container {
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .contributions-graph-container::-webkit-scrollbar {
      display: none;
    }
  }

  /* Desktop overflow */
  @media (min-width: 768px) {
    .contributions-graph-container {
      overflow-x: auto;
    }
  }

  /* Contribution day hover effect */
  .contribution-day {
    position: relative;
  }

  /* Pulse animation for high contribution days */
  .contribution-day[data-count]:not([data-count="0"]):hover {
    animation: pulse 0.3s ease-out;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1.25); }
  }
</style>